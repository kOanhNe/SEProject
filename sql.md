-- =====================================================================
-- WEBSHOE DATABASE - VERSION (6-12-2025)
-- Database: PostgreSQL
-- =====================================================================

-- =====================================================================
-- 1. CLEAN UP (Xóa bảng cũ nếu có để tránh lỗi)
-- =====================================================================
DROP TABLE IF EXISTS shoes_variant CASCADE;
DROP TABLE IF EXISTS shoes_image CASCADE;
DROP TABLE IF EXISTS shoes CASCADE;
DROP TABLE IF EXISTS category CASCADE;

-- =====================================================================
-- 2. CREATE TABLES
-- =====================================================================

-- Bảng Category
CREATE TABLE category (
id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
name VARCHAR(100) NOT NULL,       -- Map với field: name (MEN, WOMEN)
display_name VARCHAR(255)         -- Map với field: displayName (Giày Nam, Giày Nữ)
);

-- Bảng Shoes
CREATE TABLE shoes (
id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
shoes_id BIGINT,                  -- Map với field: shoesId
name VARCHAR(500) NOT NULL,
brand VARCHAR(100),
category_id BIGINT REFERENCES category(id),
description TEXT,
type VARCHAR(50) NOT NULL,        -- Map Enum: FOR_MALE, FOR_FEMALE
base_price NUMERIC(15, 2) NOT NULL,
collection VARCHAR(255),
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Bảng Images
CREATE TABLE shoes_image (
id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
image_id BIGINT,
shoes_id BIGINT NOT NULL REFERENCES shoes(id) ON DELETE CASCADE,
url VARCHAR(1000) NOT NULL,
is_thumbnail BOOLEAN DEFAULT FALSE
);

-- Bảng Variants (Size, Color, Stock)
CREATE TABLE shoes_variant (
id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
variant_id BIGINT,
shoes_id BIGINT NOT NULL REFERENCES shoes(id) ON DELETE CASCADE,
color VARCHAR(50) NOT NULL,       -- Map Enum: BLACK, WHITE, RED...
size VARCHAR(50) NOT NULL,        -- Map Enum: SIZE_35, SIZE_40...
stock INTEGER DEFAULT 0
);

-- =====================================================================
-- 3. INSERT CATEGORIES (Danh mục chuẩn)
-- =====================================================================
INSERT INTO category (name, display_name) VALUES
('MEN', 'Giày Nam'),
('WOMEN', 'Giày Nữ'),
('KIDS', 'Giày Trẻ Em');

-- =====================================================================
-- 4. SEED DATA (Dữ liệu mẫu chuẩn 50 sản phẩm)
-- =====================================================================
DO $$
DECLARE
cat_men BIGINT;
cat_women BIGINT;
cat_kids BIGINT;
v_shoe_id BIGINT;
i INT;
BEGIN
-- Lấy ID danh mục
SELECT id INTO cat_men FROM category WHERE name = 'MEN';
SELECT id INTO cat_women FROM category WHERE name = 'WOMEN';
SELECT id INTO cat_kids FROM category WHERE name = 'KIDS';

    -- -------------------------------------------------------
    -- A. GIÀY NAM (20 Sản phẩm)
    -- -------------------------------------------------------
    
    -- 1. Nike Air Max 270
    INSERT INTO shoes (shoes_id, name, brand, type, base_price, description, category_id, collection)
    VALUES (1, 'Nike Air Max 270', 'Nike', 'FOR_MALE', 3290000, 
            'Giày thể thao nam với đệm khí Max Air lớn nhất từ trước đến nay, mang lại sự thoải mái tuyệt đối.', 
            cat_men, 'Air Max Collection')
    RETURNING id INTO v_shoe_id;

    INSERT INTO shoes_image (shoes_id, url, is_thumbnail) VALUES
    (v_shoe_id, 'https://images.unsplash.com/photo-1542291026-7eec264c27ff?w=800', TRUE),
    (v_shoe_id, 'https://images.unsplash.com/photo-1606107557195-0e29a4b5b4aa?w=800', FALSE);

    INSERT INTO shoes_variant (shoes_id, color, size, stock) VALUES
    (v_shoe_id, 'BLACK', 'SIZE_40', 10), (v_shoe_id, 'BLACK', 'SIZE_41', 15), (v_shoe_id, 'WHITE', 'SIZE_42', 8);

    -- 2. Adidas Ultraboost 22
    INSERT INTO shoes (shoes_id, name, brand, type, base_price, description, category_id, collection)
    VALUES (2, 'Adidas Ultraboost 22', 'Adidas', 'FOR_MALE', 4590000, 
            'Công nghệ Boost hoàn trả năng lượng đáng kinh ngạc.', cat_men, 'Ultraboost Series')
    RETURNING id INTO v_shoe_id;

    INSERT INTO shoes_image (shoes_id, url, is_thumbnail) VALUES
    (v_shoe_id, 'https://images.unsplash.com/photo-1600185365926-3a2ce3cdb9eb?w=800', TRUE);

    INSERT INTO shoes_variant (shoes_id, color, size, stock) VALUES
    (v_shoe_id, 'WHITE', 'SIZE_41', 20), (v_shoe_id, 'BLACK', 'SIZE_42', 12);

    -- 3. Puma RS-X
    INSERT INTO shoes (shoes_id, name, brand, type, base_price, description, category_id, collection)
    VALUES (3, 'Puma RS-X Reinvention', 'Puma', 'FOR_MALE', 2890000, 'Thiết kế Retro chunky cực ngầu.', cat_men, 'RS Series')
    RETURNING id INTO v_shoe_id;
    INSERT INTO shoes_image (shoes_id, url, is_thumbnail) VALUES (v_shoe_id, 'https://images.unsplash.com/photo-1608231387042-66d1773070a5?w=800', TRUE);
    INSERT INTO shoes_variant (shoes_id, color, size, stock) VALUES (v_shoe_id, 'RED', 'SIZE_40', 5), (v_shoe_id, 'RED', 'SIZE_41', 5);

    -- Vòng lặp tạo thêm 17 sản phẩm Nam (Generic)
    FOR i IN 4..20 LOOP
        INSERT INTO shoes (shoes_id, name, brand, type, base_price, description, category_id, collection)
        VALUES (i, 'Men Sport Shoes Runner ' || i, 'Nike', 'FOR_MALE', 2000000 + (i * 10000), 
                'Giày chạy bộ nam chất lượng cao, thoáng khí.', cat_men, 'Running Collection')
        RETURNING id INTO v_shoe_id;

        -- Ảnh Random
        INSERT INTO shoes_image (shoes_id, url, is_thumbnail) VALUES
        (v_shoe_id, 'https://images.unsplash.com/photo-' || (1491553895911 + i) || '-0055eca6402d?w=800', TRUE);

        -- Variants
        INSERT INTO shoes_variant (shoes_id, color, size, stock) VALUES
        (v_shoe_id, 'BLACK', 'SIZE_40', 10),
        (v_shoe_id, 'WHITE', 'SIZE_41', 10),
        (v_shoe_id, 'BLUE', 'SIZE_42', 10);
    END LOOP;

    -- -------------------------------------------------------
    -- B. GIÀY NỮ (20 Sản phẩm)
    -- -------------------------------------------------------
    
    -- 21. Nike Air Max 97 Women
    INSERT INTO shoes (shoes_id, name, brand, type, base_price, description, category_id, collection)
    VALUES (21, 'Nike Air Max 97 SE', 'Nike', 'FOR_FEMALE', 4890000, 
            'Thiết kế gợn sóng mang tính biểu tượng, lấy cảm hứng từ tàu cao tốc Nhật Bản.', cat_women, 'Air Max Women')
    RETURNING id INTO v_shoe_id;

    INSERT INTO shoes_image (shoes_id, url, is_thumbnail) VALUES
    (v_shoe_id, 'https://images.unsplash.com/photo-1551107696-a4b0c5a0d9a2?w=800', TRUE);

    INSERT INTO shoes_variant (shoes_id, color, size, stock) VALUES
    (v_shoe_id, 'PINK', 'SIZE_36', 20), (v_shoe_id, 'WHITE', 'SIZE_37', 15);

    -- Vòng lặp tạo thêm 19 sản phẩm Nữ
    FOR i IN 22..40 LOOP
        INSERT INTO shoes (shoes_id, name, brand, type, base_price, description, category_id, collection)
        VALUES (i, 'Women Stylish Sneaker ' || i, 'Adidas', 'FOR_FEMALE', 1500000 + (i * 10000), 
                'Giày sneaker nữ thời trang, năng động.', cat_women, 'Streetwear Collection')
        RETURNING id INTO v_shoe_id;

        INSERT INTO shoes_image (shoes_id, url, is_thumbnail) VALUES
        (v_shoe_id, 'https://images.unsplash.com/photo-' || (1543163521 + i) || '-1bf539c55dd2?w=800', TRUE);

        INSERT INTO shoes_variant (shoes_id, color, size, stock) VALUES
        (v_shoe_id, 'PINK', 'SIZE_36', 10),
        (v_shoe_id, 'WHITE', 'SIZE_37', 10),
        (v_shoe_id, 'RED', 'SIZE_38', 5);
    END LOOP;

    -- -------------------------------------------------------
    -- C. GIÀY TRẺ EM (10 Sản phẩm)
    -- -------------------------------------------------------

    -- 41. Nike Dynamo Go Kids
    INSERT INTO shoes (shoes_id, name, brand, type, base_price, description, category_id, collection)
    VALUES (41, 'Nike Dynamo Go Kids', 'Nike', 'FOR_UNISEX', 1290000, 
            'Giày trẻ em dễ mang, thiết kế không dây tiện lợi.', cat_kids, 'Kids Active')
    RETURNING id INTO v_shoe_id;

    INSERT INTO shoes_image (shoes_id, url, is_thumbnail) VALUES
    (v_shoe_id, 'https://images.unsplash.com/photo-1514989940723-e8875ea6ab7d?w=800', TRUE);

    INSERT INTO shoes_variant (shoes_id, color, size, stock) VALUES
    (v_shoe_id, 'BLUE', 'SIZE_35', 25), (v_shoe_id, 'RED', 'SIZE_36', 20);

    -- Vòng lặp tạo thêm 9 sản phẩm Trẻ em
    FOR i IN 42..50 LOOP
        INSERT INTO shoes (shoes_id, name, brand, type, base_price, description, category_id, collection)
        VALUES (i, 'Kids Play Shoes ' || i, 'Puma', 'FOR_UNISEX', 800000 + (i * 5000), 
                'Giày trẻ em bền bỉ, màu sắc vui nhộn.', cat_kids, 'Play Collection')
        RETURNING id INTO v_shoe_id;

        INSERT INTO shoes_image (shoes_id, url, is_thumbnail) VALUES
        (v_shoe_id, 'https://images.unsplash.com/photo-' || (1503449368950 + i) || '-04cb72562125?w=800', TRUE);

        INSERT INTO shoes_variant (shoes_id, color, size, stock) VALUES
        (v_shoe_id, 'GREEN', 'SIZE_35', 10),
        (v_shoe_id, 'BLUE', 'SIZE_36', 10);
    END LOOP;

END $$;

-- =====================================================================
-- 5. CREATE INDEXES (Tối ưu tốc độ truy vấn)
-- =====================================================================
CREATE INDEX idx_shoes_category ON shoes(category_id);
CREATE INDEX idx_shoes_type ON shoes(type);
CREATE INDEX idx_shoes_brand ON shoes(brand);
CREATE INDEX idx_variant_shoes ON shoes_variant(shoes_id);
CREATE INDEX idx_variant_size ON shoes_variant(size);
CREATE INDEX idx_variant_color ON shoes_variant(color);

-- =====================================================================
-- 6. VERIFICATION (Kiểm tra kết quả)
-- =====================================================================
SELECT
(SELECT COUNT(*) FROM shoes) as total_shoes,
(SELECT COUNT(*) FROM shoes_variant) as total_variants,
(SELECT COUNT(*) FROM shoes_image) as total_images;