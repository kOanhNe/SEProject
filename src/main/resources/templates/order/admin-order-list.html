<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Qu·∫£n l√Ω ƒë∆°n h√†ng | WebShoe Admin</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <link rel="stylesheet" th:href="@{/css/admin.css}"/>
    <link rel="stylesheet" th:href="@{/css/inventory.css}"/>
    <link rel="stylesheet" th:href="@{/css/common.css}"/>
    
    <style>
        .stat-card {
            border: none; border-radius: 12px; padding: 20px; color: white;
            position: relative; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card h3 { font-size: 28px; font-weight: 700; margin: 0; }
        .stat-card p { font-size: 14px; opacity: 0.8; margin: 0; }
        .stat-icon { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); font-size: 40px; opacity: 0.3; }
        
        .bg-gradient-primary { background: linear-gradient(45deg, #4e73df, #224abe); }
        .bg-gradient-success { background: linear-gradient(45deg, #1cc88a, #13855c); }
        .bg-gradient-warning { background: linear-gradient(45deg, #f6c23e, #dda20a); }
        .bg-gradient-danger { background: linear-gradient(45deg, #e74a3b, #be2617); }

        .table-avatar { width: 40px; height: 40px; background: #eef2f7; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #555; margin-right: 10px; }
    </style>
</head>
<body>

<div class="admin-layout">

    <aside class="sidebar">
        <div th:replace="~{admin/sidebar :: sidebar}"></div>
    </aside>

    <div class="main">

        <header class="topbar">
            <div class="topbar-inner">
                <div class="topbar-left">
                    <button class="menu-toggle">‚ò∞</button>
                    <h3>Qu·∫£n l√Ω ƒë∆°n h√†ng</h3>
                </div>
                <div class="topbar-right">
                    <div th:replace="~{admin/inventory/inventory-notification :: notification-bell}"></div>
                    <div class="user" style="margin-left: 15px; font-weight: 600;">Admin</div>
                </div>
            </div>
        </header>

        <main class="page-content">
            
            <!-- 1. TH·ªêNG K√ä NHANH -->
            <div class="row g-4 mb-4">
                <div class="col-md-3">
                    <div class="stat-card bg-gradient-primary">
                        <div><p>T·ªïng ƒë∆°n h√†ng</p><h3 th:text="${totalElements}">0</h3></div>
                        <i class="bi bi-receipt stat-icon"></i>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card bg-gradient-warning">
                        <div><p>Ch·ªù x√°c nh·∫≠n</p><h3 th:text="${pendingCount}">0</h3></div>
                        <i class="bi bi-hourglass-split stat-icon"></i>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card bg-gradient-success">
                        <div><p>Ho√†n th√†nh</p><h3 th:text="${completedCount}">0</h3></div>
                        <i class="bi bi-check-circle stat-icon"></i>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card bg-gradient-danger">
                        <div><p>ƒê√£ h·ªßy</p><h3 th:text="${cancelledCount}">0</h3></div>
                        <i class="bi bi-x-circle stat-icon"></i>
                    </div>
                </div>
            </div>

            <!-- 2. DANH S√ÅCH ƒê∆†N H√ÄNG -->
            <div class="card border-0 shadow-sm rounded-4 p-4">
                
                <!-- Toolbar -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="mb-0 fw-bold text-secondary">üì¶ Danh s√°ch chi ti·∫øt</h5>
                    <div class="d-flex gap-2">
                        <!-- B·ªô l·ªçc tr·∫°ng th√°i (M·ªöI TH√äM) -->
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="bi bi-funnel"></i> 
                                <span th:if="${currentStatus == 'ALL'}">T·∫•t c·∫£ tr·∫°ng th√°i</span>
                                <span th:if="${currentStatus == 'PENDING'}">Ch·ªù x√°c nh·∫≠n</span>
                                <span th:if="${currentStatus == 'CONFIRMED'}">ƒê√£ x√°c nh·∫≠n</span>
                                <span th:if="${currentStatus == 'SHIPPING'}">ƒêang giao</span>
                                <span th:if="${currentStatus == 'COMPLETED'}">Ho√†n th√†nh</span>
                                <span th:if="${currentStatus == 'CANCELLED'}">ƒê√£ h·ªßy</span>
                                <span th:if="${currentStatus != 'ALL' && currentStatus != 'PENDING' && currentStatus != 'CONFIRMED' && currentStatus != 'SHIPPING' && currentStatus != 'COMPLETED' && currentStatus != 'CANCELLED'}">L·ªçc</span>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" th:href="@{/admin/orders(status='ALL')}">T·∫•t c·∫£</a></li>
                                <li><a class="dropdown-item" th:href="@{/admin/orders(status='PENDING')}">üü° Ch·ªù x√°c nh·∫≠n</a></li>
                                <li><a class="dropdown-item" th:href="@{/admin/orders(status='CONFIRMED')}">üîµ ƒê√£ x√°c nh·∫≠n</a></li>
                                <li><a class="dropdown-item" th:href="@{/admin/orders(status='SHIPPING')}">üöö ƒêang giao</a></li>
                                <li><a class="dropdown-item" th:href="@{/admin/orders(status='COMPLETED')}">üü¢ Ho√†n th√†nh</a></li>
                                <li><a class="dropdown-item" th:href="@{/admin/orders(status='CANCELLED')}">üî¥ ƒê√£ h·ªßy</a></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- B·∫£ng d·ªØ li·ªáu -->
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>M√£ ƒêH</th>
                                <th>Kh√°ch h√†ng</th>
                                <th>Ng√†y ƒë·∫∑t</th>
                                <th class="text-center">Tr·∫°ng th√°i</th>
                                <th class="text-end">T·ªïng ti·ªÅn</th>
                                <th class="text-end">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- N·∫øu kh√¥ng c√≥ ƒë∆°n h√†ng -->
                            <tr th:if="${orders == null || orders.isEmpty()}">
                                <td colspan="6" class="text-center py-5">
                                    <i class="bi bi-inbox fs-1 text-muted d-block mb-3"></i>
                                    <p class="text-muted">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o.</p>
                                </td>
                            </tr>

                            <!-- L·∫∑p d·ªØ li·ªáu -->
                            <tr th:each="order : ${orders}">
                                <td>
                                    <span class="fw-bold text-primary">#<span th:text="${order.orderId}"></span></span>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="table-avatar">
                                            <span th:text="${#strings.substring(order.customerName,0,1)}">A</span>
                                        </div>
                                        <div>
                                            <div class="fw-bold text-dark" th:text="${order.customerName}">T√™n Kh√°ch</div>
                                            <small class="text-muted" th:text="${order.customerEmail}">email@example.com</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span th:text="${#temporals.format(order.createAt, 'dd/MM/yyyy HH:mm')}"></span>
                                </td>
                                
                                <td class="text-center">
                                    <!-- Badge m√†u s·∫Øc (ƒê√£ s·ª≠a bg- ƒë·ªÉ kh·ªõp logic Service) -->
                                    <small th:text="'[' + ${order.statusColorClass} + ']'"></small><br/>
                                    <span class="badge rounded-pill" 
                                          th:classappend="'bg-' + ${order.statusColorClass}"
                                          th:style="'color: ' + (${order.statusColorClass == 'warning' || order.statusColorClass == 'info'} ? '#000' : '#fff') + ' !important; background-color: ' + (${order.statusColorClass == 'warning'} ? '#ffc107' : (${order.statusColorClass == 'info'} ? '#17a2b8' : '')) + ' !important;'"
                                          th:text="${order.statusDisplay}">
                                        Tr·∫°ng th√°i
                                    </span>
                                </td>

                                <td class="text-end fw-bold text-dark">
                                    <span th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' ƒë'"></span>
                                </td>

                                <td class="text-end">
                                    <div class="btn-group">
                                        <!-- N√∫t Xem chi ti·∫øt -->
                                        <a th:href="@{/order/tracking/{orderId}(orderId=${order.orderId})}" class="btn btn-sm btn-light border" title="Xem chi ti·∫øt">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        
                                        <!-- N√∫t Dropdown H√†nh ƒê·ªông -->
                                        <button type="button" class="btn btn-sm btn-light border dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown">
                                            <span class="visually-hidden">Toggle Dropdown</span>
                                        </button>
                                        
                                        <ul class="dropdown-menu dropdown-menu-end shadow">
                                            <li><h6 class="dropdown-header">C·∫≠p nh·∫≠t tr·∫°ng th√°i</h6></li>
                                            
                                            <!-- 1. PENDING -> CONFIRMED -->
                                            <li th:if="${order.status.name() == 'PENDING'}">
                                                <form th:action="@{/admin/orders/update-status}" method="post">
                                                    <input type="hidden" name="orderId" th:value="${order.orderId}">
                                                    <input type="hidden" name="newStatus" value="CONFIRMED">
                                                    <button class="dropdown-item text-primary"><i class="bi bi-check-lg"></i> X√°c nh·∫≠n ƒë∆°n</button>
                                                </form>
                                            </li>

                                            <!-- 2. CONFIRMED -> SHIPPING -->
                                            <li th:if="${order.status.name() == 'CONFIRMED'}">
                                                <form th:action="@{/admin/orders/update-status}" method="post">
                                                    <input type="hidden" name="orderId" th:value="${order.orderId}">
                                                    <input type="hidden" name="newStatus" value="SHIPPING">
                                                    <button class="dropdown-item text-info"><i class="bi bi-truck"></i> B·∫Øt ƒë·∫ßu giao</button>
                                                </form>
                                            </li>

                                            <!-- 3. SHIPPING -> COMPLETED -->
                                            <li th:if="${order.status.name() == 'SHIPPING'}">
                                                <form th:action="@{/admin/orders/update-status}" method="post">
                                                    <input type="hidden" name="orderId" th:value="${order.orderId}">
                                                    <input type="hidden" name="newStatus" value="COMPLETED">
                                                    <button class="dropdown-item text-success"><i class="bi bi-check-circle-fill"></i> Giao th√†nh c√¥ng</button>
                                                </form>
                                            </li>
                                            
                                            <li><hr class="dropdown-divider"></li>
                                            
                                            <!-- 4. H·ª¶Y ƒê∆†N (Lu√¥n hi·ªán tr·ª´ khi ƒë√£ Xong/H·ªßy) -->
                                            <li th:if="${order.status.name() != 'COMPLETED' && order.status.name() != 'CANCELLED'}">
                                                <form th:action="@{/admin/orders/update-status}" method="post">
                                                    <input type="hidden" name="orderId" th:value="${order.orderId}">
                                                    <input type="hidden" name="newStatus" value="CANCELLED">
                                                    <button class="dropdown-item text-danger" onclick="return confirm('H·ªßy ƒë∆°n n√†y?');"><i class="bi bi-x-circle"></i> H·ªßy ƒë∆°n</button>
                                                </form>
                                            </li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Ph√¢n trang c·∫£i ti·∫øn -->
                <div th:if="${totalPages > 1}" class="mt-4">
                    <!-- Jump to page -->
                    <div class="row align-items-center mb-3">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <label class="me-2 text-muted">Nh·∫£y t·ªõi trang:</label>
                                <div class="input-group" style="width: 120px;">
                                    <input type="number" class="form-control form-control-sm" 
                                           id="pageJump" min="1" th:max="${totalPages}" 
                                           placeholder="Trang">
                                    <button class="btn btn-outline-primary btn-sm" onclick="jumpToPage()">Go</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <small class="text-muted">Trang <span th:text="${currentPage + 1}">1</span> / <span th:text="${totalPages}">5</span></small>
                        </div>
                    </div>
                    
                    <!-- Pagination buttons -->
                    <nav>
                        <ul class="pagination justify-content-center pagination-lg">
                            <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                                <a class="page-link" th:href="@{/admin/orders(page=${currentPage - 1}, status=${currentStatus})}" style="font-size: 1.1rem; padding: 0.75rem 1rem;">Tr∆∞·ªõc</a>
                            </li>
                            
                            <!-- Show first page -->
                            <li class="page-item" th:classappend="${currentPage == 0} ? 'active'">
                                <a class="page-link" th:href="@{/admin/orders(page=0, status=${currentStatus})}" style="font-size: 1.1rem; padding: 0.75rem 1rem;">1</a>
                            </li>
                            
                            <!-- Show dots if needed -->
                            <li th:if="${currentPage > 2}" class="page-item disabled">
                                <span class="page-link" style="font-size: 1.1rem; padding: 0.75rem 1rem;">...</span>
                            </li>
                            
                            <!-- Show current page area -->
                            <li th:if="${currentPage > 0 && currentPage < totalPages - 1}" 
                                class="page-item active">
                                <span class="page-link" th:text="${currentPage + 1}" style="font-size: 1.1rem; padding: 0.75rem 1rem;">2</span>
                            </li>
                            
                            <!-- Show dots if needed -->
                            <li th:if="${currentPage < totalPages - 3}" class="page-item disabled">
                                <span class="page-link" style="font-size: 1.1rem; padding: 0.75rem 1rem;">...</span>
                            </li>
                            
                            <!-- Show last page -->
                            <li th:if="${totalPages > 1}" class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'active'">
                                <a class="page-link" th:href="@{/admin/orders(page=${totalPages - 1}, status=${currentStatus})}" 
                                   th:text="${totalPages}" style="font-size: 1.1rem; padding: 0.75rem 1rem;">5</a>
                            </li>
                            
                            <li class="page-item" th:classappend="${currentPage + 1 >= totalPages} ? 'disabled'">
                                <a class="page-link" th:href="@{/admin/orders(page=${currentPage + 1}, status=${currentStatus})}" style="font-size: 1.1rem; padding: 0.75rem 1rem;">Sau</a>
                            </li>
                        </ul>
                    </nav>
                </div>
                
                <script>
                function jumpToPage() {
                    const pageInput = document.getElementById('pageJump');
                    const pageNumber = parseInt(pageInput.value);
                    const totalPages = /*[[${totalPages}]]*/;
                    
                    if (pageNumber && pageNumber >= 1 && pageNumber <= totalPages) {
                        const status = '[[${currentStatus}]]';
                        let url = '/admin/orders?page=' + (pageNumber - 1);
                        if (status && status !== 'ALL') {
                            url += '&status=' + status;
                        }
                        window.location.href = url;
                    } else {
                        alert('Vui l√≤ng nh·∫≠p s·ªë trang h·ª£p l·ªá (1-' + totalPages + ')');
                        pageInput.focus();
                    }
                }
                
                // Allow Enter key to jump
                document.getElementById('pageJump').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        jumpToPage();
                    }
                });
                </script>

            </div>
        </main>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>