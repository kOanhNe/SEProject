<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Giỏ hàng | WEBSHOE</title>

    <th:block th:replace="~{fragments :: head_header}"></th:block>
    <link rel="stylesheet" th:href="@{/css/cart.css}">
</head>

<body>

<div th:replace="~{fragments :: header}"></div>

<main class="cart-page">
    <!-- ================== NAVBAR (dùng CSS của bạn, KHÔNG Bootstrap) ================== -->
<header>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-links">
                <a class="nav-link" th:href="@{/}">Home</a> <a class="nav-link active" th:href="@{/cart}">Cart</a>
            </div>
        </div>
    </nav>
</header>

    <!-- SUCCESS MESSAGE -->
    <div class="alert alert-success"
         th:if="${successMessage}"
         th:text="${successMessage}">
    </div>

    <!-- ================== CART EMPTY ================== -->
    <section th:if="${cartItems == null || #lists.isEmpty(cartItems)}">
        <div class="cart-empty">
            <i class="fas fa-shopping-cart cart-empty-icon"></i>
            <h3>Giỏ hàng của bạn đang trống</h3>
            <p>Hãy khám phá và thêm sản phẩm vào giỏ nhé!</p>
            <a th:href="@{/}" class="btn-cart-primary">Khám phá sản phẩm</a>
        </div>
    </section>

    <!-- ================== CART HAS ITEMS ================== -->
    <section th:if="${cartItems != null && !#lists.isEmpty(cartItems)}">


            <div class="cart-card">

                <div class="cart-card-header">
                    <span></span>
                    <span>Sản phẩm</span>
                    <span>Đơn giá</span>
                    <span>Số lượng</span>
                    <span>Thành tiền</span>
                    <span></span>
                </div>

                <div class="cart-items">

                    <div class="cart-item-row" th:each="item : ${cartItems}">

                        <!-- CHECKBOX -->
                        <input type="checkbox"
                            class="cart-item-checkbox"
                            th:value="${item.cartItemId}"
                            th:attr="data-price=${item.unitPrice}"
                            checked>

                        <!-- PRODUCT -->
                        <div class="cart-item-product">
                            <div class="cart-item-img">
                                <a th:href="@{/product/{id}(id=${item.shoeId})}">
                                    <img th:src="${item.imageUrl}"
                                         th:alt="${item.shoeName}">
                                </a>
                            </div>

                            <div class="cart-item-info">
                                <a class="cart-item-name"
                                   th:href="@{/shoes/{id}(id=${item.shoeId})}"
                                   th:text="${item.shoeName}">
                                </a>

                                <div class="cart-item-meta">
                                    <span th:text="${item.brand}"></span>
                                    <span class="dot">•</span>
                                    <span>Màu:
                                        <strong th:text="${item.color}"></strong>
                                    </span>
                                    <span class="dot">•</span>
                                    <span>Size:
                                        <strong th:text="${item.size}"></strong>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- UNIT PRICE -->
                        <div class="cart-item-price">
                            <span th:text="${#numbers.formatDecimal(item.unitPrice, 0, 'POINT', 0, 'COMMA')} + '₫'">
                            </span>
                        </div>

                        <!-- QUANTITY -->
                        <div class="cart-item-qty">
                            <form th:action="@{/cart/update}" method="post" class="qty-form">
                                <input type="hidden" name="cartItemId"
                                       th:value="${item.cartItemId}">

                                <button type="submit" name="action" value="decrease"
                                        class="qty-btn-cart btn-decrease"
                                        th:attr="data-qty=${item.quantity}">-
                                </button>

                                <input type="text" class="qty-input-cart"
                                       th:value="${item.quantity}" readonly>

                                <button type="submit" name="action" value="increase"
                                        class="qty-btn-cart">+</button>
                            </form>
                        </div>

                        <!-- TOTAL -->
                        <div class="cart-item-total">
                            <span th:text="${#numbers.formatDecimal(item.subtotal, 0, 'POINT', 0, 'COMMA')} + '₫'">
                            </span>
                        </div>

                        <!-- REMOVE -->
                        <div class="cart-item-remove">
                            <form th:action="@{/cart/remove}" method="post">
                                <input type="hidden" name="cartItemId"
                                       th:value="${item.cartItemId}">
                                <button type="submit" class="btn-remove">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </form>
                        </div>

                    </div>
                </div>
            </div>

            <!-- ================== SUMMARY ================== -->
            <div class="cart-summary-card">
                <h3>Tóm tắt đơn hàng</h3>

                <div class="summary-row">
                    <span>Tạm tính</span>
                    <span id="cart-subtotal"></span>
                </div>

                <div class="summary-row">
                    <span>Phí vận chuyển</span>
                    <span id="cart-shipping"></span>
                </div>

                <div class="summary-divider"></div>

                <div class="summary-row total">
                    <span>Tổng cộng</span>
                    <span id="cart-total"></span>
                </div>

                <!-- CHECKOUT -->
                <a th:href="@{/order/checkout(type='CART')}" class="btn-cart-primary w-100">
                    <i class="fas fa-shopping-bag"></i> Đặt hàng
                </a>

                <!-- CONTINUE SHOPPING -->
                <a th:href="@{/}" class="btn-cart-secondary w-100">
                    <i class="fas fa-arrow-left"></i> Tiếp tục mua sắm
                </a>
            </div>
    </section>

</main>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const SHIPPING_FEE = 30000;

    function formatVND(amount) {
        return amount.toLocaleString('vi-VN') + '₫';
    }

    function calculateSummary() {
        let subtotal = 0;

        document.querySelectorAll(".cart-item-checkbox:checked")
            .forEach(cb => {
                const row = cb.closest(".cart-item-row");
                const price = parseInt(cb.dataset.price);
                const quantity = parseInt(
                    row.querySelector(".qty-input-cart").value
                );
                subtotal += price * quantity;
            });

        const shipping = subtotal > 0 ? SHIPPING_FEE : 0;
        const total = subtotal + shipping;

        document.getElementById("cart-subtotal").innerText = formatVND(subtotal);
        document.getElementById("cart-shipping").innerText = formatVND(shipping);
        document.getElementById("cart-total").innerText = formatVND(total);
    }

    document.querySelectorAll(".cart-item-checkbox")
        .forEach(cb => cb.addEventListener("change", calculateSummary));

    document.querySelectorAll(".btn-decrease").forEach(btn => {
        btn.addEventListener("click", function (e) {
            const qty = parseInt(btn.dataset.qty);
            if (qty === 1) {
                e.preventDefault();
                if (confirm("Bạn có muốn xóa sản phẩm khỏi giỏ hàng không?")) {
                    btn.closest(".cart-item-row")
                        .querySelector(".cart-item-remove form")
                        .submit();
                }
            }
        });
    });

    calculateSummary();
});
</script>

<div th:replace="~{fragments :: footer}"></div>

</body>
</html>