<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Giỏ hàng | WEBSHOE</title>

    <th:block th:replace="~{fragments :: head_header}"></th:block>
    <link rel="stylesheet" th:href="@{/css/cart.css}">
</head>

<body>

<div th:replace="~{fragments :: header}"></div>

<main class="cart-page">
    <!-- ================== NAVBAR (dùng CSS của bạn, KHÔNG Bootstrap) ================== -->
<header>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-links">
                <a class="nav-link" th:href="@{/}">Home</a> 
                <a class="nav-link active" th:href="@{/cart}">Cart</a>
            </div>
        </div>
    </nav>
</header>

    <!-- SUCCESS MESSAGE -->
    <div class="alert alert-success"
         th:if="${successMessage}"
         th:text="${successMessage}">
    </div>

    <!-- ================== CART EMPTY ================== -->
    <section th:if="${cartItems == null || #lists.isEmpty(cartItems)}">
        <div class="cart-empty">
            <i class="fas fa-shopping-cart cart-empty-icon"></i>
            <h3>Giỏ hàng của bạn đang trống</h3>
            <p>Hãy khám phá và thêm sản phẩm vào giỏ nhé!</p>
            <a th:href="@{/}" class="btn-cart-primary">Khám phá sản phẩm</a>
        </div>
    </section>

    <!-- ================== CART HAS ITEMS ================== -->
    <section th:if="${cartItems != null && !#lists.isEmpty(cartItems)}">


            <div class="cart-card">

                <div class="cart-card-header">
                    <span></span>
                    <span>Sản phẩm</span>
                    <span>Đơn giá</span>
                    <span>Số lượng</span>
                    <span>Thành tiền</span>
                    <span></span>
                </div>

                <div class="cart-items">

                    <div class="cart-item-row" th:each="item : ${cartItems}">

                        <!-- CHECKBOX -->
                        <input type="checkbox"
                            class="cart-item-checkbox"
                            name="selectedCartItemIds"
                            th:value="${item.cartItemId}"
                            checked>

                        <!-- PRODUCT -->
                        <div class="cart-item-product">
                            <div class="cart-item-img">
                                <a th:href="@{/shoes/{id}(id=${item.shoeId})}">
                                    <img th:src="${item.imageUrl}"
                                         th:alt="${item.shoeName}">
                                </a>
                            </div>

                            <div class="cart-item-info">
                                <a class="cart-item-name"
                                   th:href="@{/shoes/{id}(id=${item.shoeId})}"
                                   th:text="${item.shoeName}">
                                </a>

                                <div class="cart-item-meta">
                                    <span th:text="${item.brand}"></span>
                                    <span class="dot">•</span>
                                    <span>Màu:
                                        <strong th:text="${item.color}"></strong>
                                    </span>
                                    <span class="dot">•</span>
                                    <span>Size:
                                        <strong th:text="${item.size}"></strong>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- UNIT PRICE -->
                        <div class="cart-item-price">
                            <span th:text="${#numbers.formatDecimal(item.unitPrice, 0, 'POINT', 0, 'COMMA')} + '₫'">
                            </span>
                        </div>

                        <!-- QUANTITY -->
                        <div class="cart-item-qty">
                            <form th:action="@{/cart/update}" method="post" class="qty-form">
                                <input type="hidden" name="cartItemId"
                                       th:value="${item.cartItemId}">

                                <button type="submit" name="action" value="decrease"
                                        class="qty-btn-cart btn-decrease"
                                        th:attr="data-qty=${item.quantity}">-
                                </button>

                                <input type="text" class="qty-input-cart"
                                       th:value="${item.quantity}" readonly>

                                <button type="submit" name="action" value="increase"
                                        class="qty-btn-cart">+</button>
                            </form>
                        </div>

                        <!-- TOTAL -->
                        <div class="cart-item-total">
                            <span th:text="${#numbers.formatDecimal(item.subtotal, 0, 'POINT', 0, 'COMMA')} + '₫'">
                            </span>
                        </div>

                        <!-- REMOVE -->
                        <div class="cart-item-remove">
                            <form th:action="@{/cart/remove}" method="post">
                                <input type="hidden" name="cartItemId"
                                       th:value="${item.cartItemId}">
                                <button type="submit" class="btn-remove">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </form>
                        </div>

                    </div>
                </div>
            </div>

            <!-- ================== SUMMARY ================== -->
            <div class="cart-summary-card">
                <h3>Tóm tắt đơn hàng</h3>

                <div class="summary-row">
                    <span>Tạm tính</span>
                    <span id="summary-subtotal" th:text="${#numbers.formatDecimal(cartSubtotal, 0, 'POINT', 0, 'COMMA')} + '₫'"></span>
                </div>

                <div class="summary-row">
                    <span>Phí vận chuyển</span>
                    <span id="summary-shipping" th:text="${#numbers.formatDecimal(cartShipping, 0, 'POINT', 0, 'COMMA')} + '₫'"></span>
                </div>

                <div class="summary-divider"></div>

                <div class="summary-row total">
                    <span>Tổng cộng</span>
                    <span id="summary-total" th:text="${#numbers.formatDecimal(cartTotal, 0, 'POINT', 0, 'COMMA')} + '₫'"></span>
                </div>

                <!-- CHECKOUT FORM -->
                <form id="checkout-form" th:action="@{/order/checkout}" method="get">
                    <input type="hidden" name="type" value="CART">
                    <input type="hidden" name="cartItemIds" id="selected-cart-item-ids" value="">
                    <button type="submit" class="btn-cart-primary w-100" id="checkout-btn">
                        <i class="fas fa-shopping-bag"></i> Đặt hàng
                    </button>
                </form>

                <!-- CONTINUE SHOPPING -->
                <a th:href="@{/}" class="btn-cart-secondary w-100">
                    <i class="fas fa-arrow-left"></i> Tiếp tục mua sắm
                </a>
            </div>
    </section>

</main>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const SHIPPING_FEE = 30000;

    // ============ FUNCTION: Format number with thousand separator ============
    function formatCurrency(value) {
        return Math.round(value).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".") + "₫";
    }

    // ============ FUNCTION: Calculate and update summary ============
    function updateSummary() {
        const checkboxes = document.querySelectorAll(".cart-item-checkbox");
        let subtotal = 0;
        let selectedCount = 0;

        checkboxes.forEach(checkbox => {
            if (checkbox.checked) {
                const row = checkbox.closest(".cart-item-row");
                const totalText = row.querySelector(".cart-item-total span").textContent;
                // Remove '₫' and '.' to parse the number
                const itemTotal = parseFloat(totalText.replace(/[₫.]/g, ""));
                subtotal += itemTotal;
                selectedCount++;
            }
        });

        const shipping = selectedCount > 0 ? SHIPPING_FEE : 0;
        const total = subtotal + shipping;

        // Update the summary display
        document.getElementById("summary-subtotal").textContent = formatCurrency(subtotal);
        document.getElementById("summary-shipping").textContent = formatCurrency(shipping);
        document.getElementById("summary-total").textContent = formatCurrency(total);
    }

    // ============ EVENT: Listen to checkbox changes ============
    document.querySelectorAll(".cart-item-checkbox").forEach(checkbox => {
        checkbox.addEventListener("change", updateSummary);
    });

    // ============ EVENT: Handle checkout form submission ============
    document.getElementById("checkout-form").addEventListener("submit", function(e) {
        const checkboxes = document.querySelectorAll(".cart-item-checkbox:checked");
        
        console.log("=== CHECKOUT FORM SUBMIT ===");
        console.log("Number of checked items:", checkboxes.length);
        
        if (checkboxes.length === 0) {
            e.preventDefault();
            alert("Vui lòng chọn ít nhất một sản phẩm để đặt hàng!");
            return false;
        }

        // Collect selected cart item IDs
        const selectedIds = Array.from(checkboxes).map(cb => {
            console.log("Selected checkbox value:", cb.value);
            return cb.value;
        }).join(",");
        
        console.log("Selected IDs string:", selectedIds);
        document.getElementById("selected-cart-item-ids").value = selectedIds;
        console.log("Hidden input value set to:", document.getElementById("selected-cart-item-ids").value);
    });

    // ============ EVENT: Handle decrease button (delete confirmation) ============
    document.querySelectorAll(".btn-decrease").forEach(btn => {
        btn.addEventListener("click", function (e) {

            const qty = parseInt(btn.dataset.qty);

            // Nếu còn 1 sản phẩm mà bấm "-"
            if (qty === 1) {
                e.preventDefault(); // chặn submit form update

                const confirmDelete = confirm(
                    "Bạn có muốn xóa sản phẩm khỏi giỏ hàng không?"
                );

                if (confirmDelete) {
                    // submit form remove cùng dòng
                    const row = btn.closest(".cart-item-row");
                    const removeForm = row.querySelector(".cart-item-remove form");
                    removeForm.submit();
                }
                // Cancel → không làm gì
            }
        });
    });

    // Initialize summary on page load
    updateSummary();

});
</script>

<div th:replace="~{fragments :: footer}"></div>

</body>
</html>