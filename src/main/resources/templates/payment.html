<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh to√°n - WEBSHOE</title>
    <th:block th:replace="~{fragments :: head_header}"></th:block>
    <link rel="stylesheet" th:href="@{/css/cart.css}">
    <style>
        .checkout-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2rem;
        }
        
        .payment-form {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .checkout-summary {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            height: fit-content;
            position: sticky;
            top: 2rem;
        }
        
        .form-section {
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid #eee;
        }
        
        .form-section:last-child {
            border-bottom: none;
        }
        
        .form-section h3 {
            margin-bottom: 1rem;
            color: #333;
        }
        
        .shipping-info {
            background: #f5f5f5;
            padding: 1rem;
            border-radius: 4px;
        }
        
        .shipping-info p {
            margin: 0.5rem 0;
            color: #666;
        }
        
        .shipping-info strong {
            color: #333;
        }
        
        .voucher-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .voucher-item {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .voucher-item:hover {
            border-color: #e53935;
        }
        
        .voucher-item.selected {
            border-color: #e53935;
            background: #fff5f5;
        }
        
        .voucher-item input[type="radio"] {
            display: none;
        }
        
        .voucher-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .voucher-code {
            background: #e53935;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .voucher-title {
            font-weight: 600;
            flex: 1;
        }
        
        .voucher-discount {
            color: #e53935;
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .voucher-description {
            color: #666;
            font-size: 0.9rem;
            margin: 0.5rem 0;
        }
        
        .voucher-conditions {
            font-size: 0.85rem;
            color: #999;
        }
        
        .no-voucher {
            color: #999;
            font-style: italic;
        }
        
        .payment-methods {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .payment-method {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .payment-method:hover {
            border-color: #e53935;
        }
        
        .payment-method.selected {
            border-color: #e53935;
            background: #fff5f5;
        }
        
        .payment-method input[type="radio"] {
            display: none;
        }
        
        .payment-method-icon {
            width: 50px;
            height: 50px;
            object-fit: contain;
        }
        
        .payment-method-info {
            flex: 1;
        }
        
        .payment-method-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .payment-method-desc {
            color: #666;
            font-size: 0.9rem;
        }
        
        .summary-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid #eee;
        }
        
        .summary-item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
        }
        
        .summary-item-info {
            flex: 1;
        }
        
        .summary-item-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .summary-item-variant {
            font-size: 0.9rem;
            color: #666;
        }
        
        .summary-pricing {
            margin-top: 1.5rem;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
        }
        
        .summary-row.discount {
            color: #4caf50;
        }
        
        .summary-row.total {
            font-size: 1.25rem;
            font-weight: 700;
            color: #e53935;
            border-top: 2px solid #333;
            padding-top: 1rem;
            margin-top: 1rem;
        }
        
        .btn-submit {
            width: 100%;
            padding: 1rem;
            background: #e53935;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1.5rem;
        }
        
        .btn-submit:hover {
            background: #c62828;
        }
        
        .btn-back {
            width: 100%;
            padding: 1rem;
            background: white;
            color: #666;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 1rem;
        }
        
        .btn-back:hover {
            background: #f5f5f5;
        }
        
        .progress-steps {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
            gap: 2rem;
        }
        
        .step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #ddd;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        
        .step.active .step-number {
            background: #e53935;
            color: white;
        }
        
        .step.completed .step-number {
            background: #4caf50;
            color: white;
        }
        
        /* Voucher Section Styles */
        .voucher-input-section {
            margin-bottom: 1.5rem;
        }
        
        .voucher-input-group {
            display: flex;
            gap: 0.5rem;
        }
        
        .voucher-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .voucher-input:focus {
            outline: none;
            border-color: #e53935;
        }
        
        .btn-apply-voucher {
            padding: 0.75rem 1.5rem;
            background: #e53935;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-apply-voucher:hover:not(:disabled) {
            background: #c62828;
        }
        
        .btn-apply-voucher:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .voucher-message {
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }
        
        .voucher-message .success {
            color: #4caf50;
        }
        
        .voucher-message .error {
            color: #e53935;
        }
        
        .applied-voucher {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border: 2px solid #4caf50;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .applied-voucher-content {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .applied-voucher-icon {
            font-size: 2rem;
        }
        
        .applied-voucher-info {
            flex: 1;
        }
        
        .applied-voucher-code {
            font-weight: 700;
            color: #2e7d32;
            font-size: 1.1rem;
        }
        
        .applied-voucher-desc {
            color: #388e3c;
            font-size: 0.9rem;
        }
        
        .btn-remove-voucher {
            background: transparent;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 0.5rem;
            font-size: 1.2rem;
            transition: color 0.3s;
        }
        
        .btn-remove-voucher:hover {
            color: #e53935;
        }
        
        .voucher-available-section {
            margin-top: 1.5rem;
        }
        
        .voucher-section-title {
            font-weight: 600;
            color: #666;
            margin-bottom: 1rem;
            font-size: 0.95rem;
        }
        
        .voucher-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .voucher-item {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }
        
        .voucher-item:hover:not(.disabled) {
            border-color: #e53935;
            background: #fff5f5;
        }
        
        .voucher-item.selected {
            border-color: #4caf50;
            background: #e8f5e9;
        }
        
        .voucher-item.disabled {
            opacity: 0.7;
            cursor: not-allowed;
            background: #f8f8f8;
            border-color: #e0e0e0;
        }
        
        .voucher-item.disabled:hover {
            border-color: #e0e0e0;
            background: #f8f8f8;
        }
        
        .voucher-item.disabled .voucher-code {
            background: #9e9e9e;
        }
        
        .voucher-item.disabled .voucher-discount {
            color: #9e9e9e;
        }
        
        .voucher-item.disabled .voucher-description {
            color: #999;
        }
        
        .disabled-text {
            color: #9e9e9e !important;
        }
        
        .usage-limit-info {
            display: inline-block;
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.25rem;
        }
        
        .usage-exceeded {
            color: #e53935;
            font-weight: 500;
        }
        
        .voucher-item input[type="radio"] {
            display: none;
        }
        
        .voucher-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .voucher-code {
            background: #e53935;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .voucher-discount {
            color: #e53935;
            font-weight: 700;
            font-size: 1rem;
        }
        
        .voucher-description {
            color: #333;
            font-size: 0.9rem;
            font-weight: 500;
            margin: 0.5rem 0;
        }
        
        .voucher-conditions {
            font-size: 0.8rem;
            color: #666;
        }
        
        .voucher-conditions .not-applicable {
            color: #f57c00;
            font-weight: 500;
        }
        
        .no-voucher {
            text-align: center;
            padding: 1.5rem;
            background: #f5f5f5;
            border-radius: 8px;
            color: #666;
        }
        
        .no-voucher p {
            margin-bottom: 1rem;
        }
        
        .btn-view-vouchers {
            display: inline-block;
            padding: 0.5rem 1rem;
            background: #e53935;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 0.9rem;
            transition: background 0.3s;
        }
        
        .btn-view-vouchers:hover {
            background: #c62828;
            color: white;
        }
        
        @media (max-width: 768px) {
            .checkout-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    
    <div th:replace="~{fragments :: header}"></div>
    
    <div class="checkout-container">
        <!-- Form thanh to√°n -->
        <div class="payment-form">
            <div class="progress-steps">
                <div class="step completed">
                    <div class="step-number">‚úì</div>
                    <span>Th√¥ng tin giao h√†ng</span>
                </div>
                <div class="step active">
                    <div class="step-number">2</div>
                    <span>Thanh to√°n</span>
                </div>
            </div>
            
            <form action="/order/create" method="POST" id="paymentForm">
                <!-- Hidden inputs ƒë·ªÉ g·ª≠i th√¥ng tin giao h√†ng -->
                <input type="hidden" name="recipientName" th:value="${recipientName ?: ''}">
                <input type="hidden" name="recipientPhone" th:value="${recipientPhone ?: ''}">
                <input type="hidden" name="recipientEmail" th:value="${recipientEmail ?: ''}">
                <input type="hidden" name="recipientAddress" th:value="${recipientAddress ?: ''}">
                <input type="hidden" name="note" th:value="${note ?: ''}">
                
                <!-- Th√¥ng tin giao h√†ng (ch·ªâ hi·ªÉn th·ªã) -->
                <div class="form-section">
                    <h3>Th√¥ng tin giao h√†ng</h3>
                    <div class="shipping-info">
                        <p><strong>Ng∆∞·ªùi nh·∫≠n:</strong> <span th:text="${recipientName}"></span></p>
                        <p><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> <span th:text="${recipientPhone}"></span></p>
                        <p th:if="${recipientEmail}"><strong>Email:</strong> <span th:text="${recipientEmail}"></span></p>
                        <p><strong>ƒê·ªãa ch·ªâ:</strong> <span th:text="${recipientAddress}"></span></p>
                        <p th:if="${note}"><strong>Ghi ch√∫:</strong> <span th:text="${note}"></span></p>
                    </div>
                    <button type="button" class="btn-back" onclick="window.history.back()">
                        ‚Üê S·ª≠a th√¥ng tin giao h√†ng
                    </button>
                </div>
                
                <!-- Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n -->
                <div class="form-section">
                    <h3>Ph∆∞∆°ng th·ª©c thanh to√°n</h3>
                    <div class="payment-methods">
                        <div class="payment-method selected" onclick="selectPayment('COD', this)" id="payment-cod">
                            <input type="radio" name="paymentMethod" value="COD" id="radio-cod" checked required>
                            <img th:src="@{/images/R.png}" alt="COD" class="payment-method-icon">
                            <div class="payment-method-info">
                                <div class="payment-method-name">Thanh to√°n khi nh·∫≠n h√†ng (COD)</div>
                                <div class="payment-method-desc">Thanh to√°n b·∫±ng ti·ªÅn m·∫∑t khi nh·∫≠n h√†ng</div>
                            </div>
                        </div>
                        
                        <div class="payment-method" onclick="selectPayment('VNPAY', this)" id="payment-vnpay">
                            <input type="radio" name="paymentMethod" value="VNPAY" id="radio-vnpay" required>
                            <img th:src="@{/images/vnpay.jpg}" alt="VNPay" class="payment-method-icon">
                            <div class="payment-method-info">
                                <div class="payment-method-name">Thanh to√°n VNPay</div>
                                <div class="payment-method-desc">Thanh to√°n tr·ª±c tuy·∫øn qua c·ªïng VNPay (ATM, Visa, MasterCard, QR Code) </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Ch·ªçn m√£ gi·∫£m gi√° -->
                <div class="form-section">
                    <h3>üéÅ M√£ gi·∫£m gi√°</h3>
                    
                    <!-- Input nh·∫≠p m√£ voucher -->
                    <div class="voucher-input-section">
                        <div class="voucher-input-group">
                            <input type="text" id="voucherCodeInput" 
                                   placeholder="Nh·∫≠p m√£ gi·∫£m gi√°..." 
                                   class="voucher-input">
                            <button type="button" id="applyVoucherBtn" onclick="applyVoucherCode()" class="btn-apply-voucher">
                                √Åp d·ª•ng
                            </button>
                        </div>
                        <div id="voucherMessage" class="voucher-message"></div>
                    </div>
                    
                    <!-- Hidden input ƒë·ªÉ g·ª≠i voucher code trong form -->
                    <input type="hidden" name="voucherCode" id="selectedVoucherCode" value="">
                    
                    <!-- Hi·ªán voucher ƒë√£ ch·ªçn -->
                    <div id="appliedVoucherSection" class="applied-voucher" style="display: none;">
                        <div class="applied-voucher-content">
                            <div class="applied-voucher-icon">üé´</div>
                            <div class="applied-voucher-info">
                                <div class="applied-voucher-code" id="appliedVoucherCode"></div>
                                <div class="applied-voucher-desc" id="appliedVoucherDesc"></div>
                            </div>
                            <button type="button" class="btn-remove-voucher" onclick="removeVoucher()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Danh s√°ch voucher c√≥ th·ªÉ d√πng -->
                    <div th:if="${vouchers != null and !vouchers.isEmpty()}" class="voucher-available-section">
                        <p class="voucher-section-title">Ho·∫∑c ch·ªçn m√£ gi·∫£m gi√°:</p>
                        <div class="voucher-list">
                            <div th:each="voucher : ${vouchers}" 
                                 class="voucher-item"
                                 th:classappend="${!voucher.applicable} ? 'disabled' : ''"
                                 th:data-code="${voucher.code}"
                                 th:data-min="${voucher.minOrderValue != null ? voucher.minOrderValue : 0}"
                                 th:data-applicable="${voucher.applicable}">
                                
                                <div class="voucher-header">
                                    <span class="voucher-code" th:text="${voucher.code}">VOUCHER123</span>
                                    <span class="voucher-discount" th:classappend="${!voucher.applicable} ? 'disabled-text' : ''">
                                        <span th:if="${voucher.discountType.name() == 'PERCENTAGE'}">
                                            Gi·∫£m <span th:text="${voucher.discountValue}">10</span>%
                                            <span th:if="${voucher.maxDiscountValue != null and voucher.maxDiscountValue > 0}">
                                                (t·ªëi ƒëa <span th:text="${#numbers.formatDecimal(voucher.maxDiscountValue, 0, 'COMMA', 0, 'POINT')}">50000</span>‚Ç´)
                                            </span>
                                        </span>
                                        <span th:if="${voucher.discountType.name() == 'FIXED_AMOUNT'}">
                                            Gi·∫£m <span th:text="${#numbers.formatDecimal(voucher.discountValue, 0, 'COMMA', 0, 'POINT')}">10000</span>‚Ç´
                                        </span>
                                    </span>
                                </div>
                                
                                <div class="voucher-description" th:text="${voucher.description != null ? voucher.description : voucher.campaignName}">Gi·∫£m gi√° ƒë·∫∑c bi·ªát</div>
                                
                                <div class="voucher-conditions">
                                    <span th:if="${voucher.minOrderValue != null and voucher.minOrderValue > 0}">
                                        ƒê∆°n t·ªëi thi·ªÉu: <span th:text="${#numbers.formatDecimal(voucher.minOrderValue, 0, 'COMMA', 0, 'POINT')}">100000</span>‚Ç´
                                    </span>
                                    <!-- Hi·ªÉn th·ªã gi·ªõi h·∫°n l∆∞·ª£t d√πng -->
                                    <span th:if="${voucher.maxRedeemPerCustomer != null and voucher.maxRedeemPerCustomer > 0}">
                                        <br>Gi·ªõi h·∫°n: <span th:text="${voucher.maxRedeemPerCustomer}">5</span> l∆∞·ª£t/ng∆∞·ªùi
                                        <span th:if="${voucher.userUsageCount > 0}">
                                            (ƒë√£ d√πng <span th:text="${voucher.userUsageCount}">0</span> l∆∞·ª£t)
                                        </span>
                                    </span>
                                    <!-- Hi·ªÉn th·ªã l√Ω do kh√¥ng √°p d·ª•ng ƒë∆∞·ª£c -->
                                    <span th:if="${!voucher.applicable}" class="not-applicable">
                                        <br>‚ö†Ô∏è <span th:text="${voucher.reason}">Ch∆∞a ƒë·ªß ƒëi·ªÅu ki·ªán</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div th:if="${vouchers == null or vouchers.isEmpty()}" class="no-voucher">
                        <p>Kh√¥ng c√≥ m√£ gi·∫£m gi√° kh·∫£ d·ª•ng cho ƒë∆°n h√†ng n√†y</p>
                        <a th:href="@{/vouchers}" class="btn-view-vouchers">Xem t·∫•t c·∫£ m√£ gi·∫£m gi√°</a>
                    </div>
                </div>
                
                <button type="submit" class="btn-submit">X√°c nh·∫≠n ƒë·∫∑t h√†ng</button>
            </form>
        </div>
        
        <!-- T√≥m t·∫Øt ƒë∆°n h√†ng -->
        <div class="checkout-summary">
            <h3>ƒê∆°n h√†ng c·ªßa b·∫°n</h3>
            
            <!-- ƒê·∫∑t h√†ng t·ª´ gi·ªè -->
            <div th:if="${type == 'CART'}">
                <div th:each="item : ${cartItems}" class="summary-item">
                    <img th:src="@{${!item.variant.shoes.images.empty ? item.variant.shoes.images.iterator().next().url : '/images/no-image.png'}}" 
                         th:alt="${item.variant.shoes.name}">
                    <div class="summary-item-info">
                        <div class="summary-item-name" th:text="${item.variant.shoes.name}"></div>
                        <div class="summary-item-variant">
                            Size: <span th:text="${item.variant.size}"></span> | 
                            M√†u: <span th:text="${item.variant.color}"></span>
                        </div>
                        <div>SL: <span th:text="${item.quantity}"></span></div>
                    </div>
                    <div class="summary-item-price" 
                         th:text="${#numbers.formatDecimal(item.unitPrice * item.quantity, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'">
                    </div>
                </div>
            </div>
            
            <!-- Mua ngay -->
            <div th:if="${type == 'BUY_NOW'}">
                <div class="summary-item">
                    <img th:src="@{${!variant.shoes.images.empty ? variant.shoes.images.iterator().next().url : '/images/no-image.png'}}" 
                         th:alt="${variant.shoes.name}">
                    <div class="summary-item-info">
                        <div class="summary-item-name" th:text="${variant.shoes.name}"></div>
                        <div class="summary-item-variant">
                            Size: <span th:text="${variant.size}"></span> | 
                            M√†u: <span th:text="${variant.color}"></span>
                        </div>
                        <div>SL: <span th:text="${quantity}"></span></div>
                    </div>
                    <div class="summary-item-price" 
                         th:text="${#numbers.formatDecimal(subtotal, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'">
                    </div>
                </div>
            </div>
            
            <!-- T√≠nh ti·ªÅn -->
            <div class="summary-pricing">
                <div class="summary-row">
                    <span>T·∫°m t√≠nh:</span>
                    <span id="subtotal-display" th:text="${#numbers.formatDecimal(subtotal, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"></span>
                </div>
                <div class="summary-row">
                    <span>Ph√≠ v·∫≠n chuy·ªÉn:</span>
                    <span id="shipping-display" th:text="${#numbers.formatDecimal(shipping, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"></span>
                </div>
                <div class="summary-row discount" id="discount-row" style="display: none;">
                    <span>Gi·∫£m gi√°:</span>
                    <span id="discount-display">-0 ‚Ç´</span>
                </div>
                <div class="summary-row total">
                    <span>T·ªïng c·ªông:</span>
                    <span id="total-display" th:text="${#numbers.formatDecimal(total, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"></span>
                </div>
            </div>
        </div>
    </div>
    
    <script th:inline="javascript">

        const subtotal = [[${subtotal}]];
        const shipping = [[${shipping}]];
        let currentDiscount = 0;
        
        console.log('Payment page loaded. Subtotal:', subtotal, 'Shipping:', shipping);
        
        // Kh·ªüi t·∫°o event listeners khi DOM ƒë√£ s·∫µn s√†ng
        document.addEventListener('DOMContentLoaded', function() {
            // Th√™m click event cho t·∫•t c·∫£ voucher items
            document.querySelectorAll('.voucher-item').forEach(function(item) {
                item.addEventListener('click', function() {
                    const isApplicable = this.getAttribute('data-applicable') === 'true';
                    if (isApplicable) {
                        selectVoucher(this);
                    } else {
                        // Hi·ªÉn th·ªã th√¥ng b√°o khi click v√†o voucher kh√¥ng kh·∫£ d·ª•ng
                        const reason = this.querySelector('.not-applicable span');
                        if (reason) {
                            showVoucherMessage(reason.textContent, 'error');
                        }
                    }
                });
            });
        });
        /*<![CDATA[*/
        const subtotal = /*[[${subtotal}]]*/ 0;
        const shipping = /*[[${shipping}]]*/ 0;
        /*]]*/
        
        function selectPayment(method, element) {
            document.querySelectorAll('.payment-method').forEach(item => {
                item.classList.remove('selected');
            });
            element.classList.add('selected');
            document.getElementById('radio-' + method.toLowerCase()).checked = true;
        }
        
        function selectVoucher(element) {
            const code = element.getAttribute('data-code');
            console.log('Selecting voucher:', code);
            document.getElementById('voucherCodeInput').value = code;
            applyVoucherCode();
        }
        
        function showVoucherMessage(message, type) {
            const messageEl = document.getElementById('voucherMessage');
            messageEl.innerHTML = '<span class="' + type + '">' + message + '</span>';
        }
        
        function applyVoucherCode() {
            const voucherCode = document.getElementById('voucherCodeInput').value.trim();
            const messageEl = document.getElementById('voucherMessage');
            const applyBtn = document.getElementById('applyVoucherBtn');
            
            console.log('Applying voucher code:', voucherCode);
            
            if (!voucherCode) {
                messageEl.innerHTML = '<span class="error">Vui l√≤ng nh·∫≠p m√£ gi·∫£m gi√°</span>';
                return;
            }
            
            // Disable button while processing
            applyBtn.disabled = true;
            applyBtn.textContent = 'ƒêang x·ª≠ l√Ω...';
            
            const url = '/vouchers/api/validate';
            const body = `voucherCode=${encodeURIComponent(voucherCode)}&orderSubTotal=${subtotal}`;
            
            console.log('Calling API:', url, 'Body:', body);
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: body
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.valid) {
                    // Success - show applied voucher
                    currentDiscount = data.discountAmount;
                    
                    document.getElementById('selectedVoucherCode').value = voucherCode;
                    document.getElementById('appliedVoucherCode').textContent = data.voucherCode;
                    document.getElementById('appliedVoucherDesc').textContent = data.message;
                    document.getElementById('appliedVoucherSection').style.display = 'block';
                    
                    // Highlight selected voucher in list
                    document.querySelectorAll('.voucher-item').forEach(item => {
                        if (item.getAttribute('data-code') === voucherCode) {
                            item.classList.add('selected');
                        } else {
                            item.classList.remove('selected');
                        }
                    });
                    
                    messageEl.innerHTML = '<span class="success">' + data.message + '</span>';
                    
                    // Update pricing
                    updatePricing();
                } else {
                    messageEl.innerHTML = '<span class="error">' + data.message + '</span>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                messageEl.innerHTML = '<span class="error">C√≥ l·ªói x·∫£y ra: ' + error.message + '</span>';
            })
            .finally(() => {
                applyBtn.disabled = false;
                applyBtn.textContent = '√Åp d·ª•ng';
            });
        }
        
        function removeVoucher() {
            console.log('Removing voucher');
            currentDiscount = 0;
            document.getElementById('selectedVoucherCode').value = '';
            document.getElementById('voucherCodeInput').value = '';
            document.getElementById('appliedVoucherSection').style.display = 'none';
            document.getElementById('voucherMessage').innerHTML = '';
            
            document.querySelectorAll('.voucher-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            updatePricing();
        }
        
        function updatePricing() {
            const discountRow = document.getElementById('discount-row');
            const discountDisplay = document.getElementById('discount-display');
            const totalDisplay = document.getElementById('total-display');
            
            console.log('Updating pricing. Discount:', currentDiscount);
            
            if (currentDiscount > 0) {
                discountRow.style.display = 'flex';
                discountDisplay.textContent = '-' + formatCurrency(currentDiscount) + ' ‚Ç´';
            } else {
                discountRow.style.display = 'none';
            }
            
            const total = subtotal + shipping - currentDiscount;
            totalDisplay.textContent = formatCurrency(total) + ' ‚Ç´';
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN').format(Math.round(amount));
        }
    </script>
    
    <div th:replace="~{fragments :: footer}"></div>
</body>
</html>
