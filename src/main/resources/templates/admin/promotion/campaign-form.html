<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title th:text="${pageTitle}">Chiến dịch</title>
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <link rel="stylesheet" th:href="@{/css/common.css}">
</head>
<body>
<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
</div>

<div class="admin-layout">
    <aside class="sidebar">
        <div th:replace="~{admin/sidebar :: sidebar}"></div>
    </aside>
    <div class="main">
        <header class="topbar">
            <div class="topbar-inner">
                <div class="topbar-left">
                    <button class="menu-toggle" aria-label="Toggle menu">☰</button>
                    <h3 th:text="${pageTitle}">Chiến dịch</h3>
                </div>
            </div>
        </header>
        <main class="page-content">
            <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

            <div class="card" style="max-width: 900px; margin: 0 auto;">
                <div style="margin-bottom: 24px;">
                    <h3 class="section-title" th:text="${pageTitle}">Tạo chiến dịch</h3>
                    <p class="section-sub">Điền đầy đủ thông tin chiến dịch để áp dụng giảm giá cho khách hàng.</p>
                </div>
                <form th:action="${campaign.campaignId} == null ? @{/admin/promotions/campaigns/create} : @{'/admin/promotions/campaigns/' + ${campaign.campaignId} + '/edit'}" method="post" th:object="${campaign}">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Tên chiến dịch</label>
                            <input type="text" th:field="*{name}" required placeholder="VD: Giảm giá cuối năm">
                            <small style="color: #6b7280; font-size: 12px;">Tên hiển thị của chiến dịch khuyến mãi</small>
                            <div class="error-message" th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></div>
                        </div>
                        <div class="form-group">
                            <label>Trạng thái</label>
                            <input type="text" th:value="${campaign.status != null ? campaign.status : 'AUTO'}" disabled style="background: #f3f4f6; color: #6b7280;">
                            <small style="color: #6b7280; font-size: 12px;">Trạng thái tự động cập nhật theo ngày</small>
                        </div>
                    </div>

                    <div class="form-group full-width">
                        <label>Mô tả</label>
                        <textarea th:field="*{description}" rows="3" placeholder="Mô tả chi tiết về chiến dịch..."></textarea>
                        <small style="color: #6b7280; font-size: 12px;">Thông tin bổ sung về chiến dịch (không bắt buộc)</small>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Ngày bắt đầu</label>
                            <input type="date" name="startDate" 
                                   th:value="${campaign.startDate != null ? campaign.startDate : ''}"
                                   required>
                            <small style="color: #6b7280; font-size: 12px;">Ngày bắt đầu áp dụng chiến dịch</small>
                            <div class="error-message" th:if="${#fields.hasErrors('startDate')}" th:errors="*{startDate}"></div>
                        </div>
                        <div class="form-group">
                            <label class="required">Ngày kết thúc</label>
                            <input type="date" name="endDate"
                                   th:value="${campaign.endDate != null ? campaign.endDate : ''}"
                                   required>
                            <small style="color: #6b7280; font-size: 12px;">Ngày kết thúc chiến dịch</small>
                            <div class="error-message" th:if="${#fields.hasErrors('endDate')}" th:errors="*{endDate}"></div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Loại giảm</label>
                            <select th:field="*{discountType}" required id="discountTypeSelect" onchange="updateDiscountValuePlaceholder()">
                                <option value="">-- Chọn loại giảm --</option>
                                <option value="PERCENT">Giảm theo phần trăm (%)</option>
                                <option value="FIXED_AMOUNT">Giảm số tiền cố định (VNĐ)</option>
                            </select>
                            <small style="color: #6b7280; font-size: 12px;">PERCENT (%) hoặc FIXED_AMOUNT (VNĐ)</small>
                            <div class="error-message" th:if="${#fields.hasErrors('discountType')}" th:errors="*{discountType}"></div>
                        </div>
                        <div class="form-group">
                            <label class="required">Giá trị giảm</label>
                            <input type="text" id="discountValue" required placeholder="VD: 10 hoặc 100,000">
                            <input type="hidden" th:field="*{discountValue}" id="discountValueHidden">
                            <small style="color: #6b7280; font-size: 12px;" id="discountValueHint">Nếu % thì nhập 10, nếu VNĐ thì nhập 100,000</small>
                            <div class="error-message" th:if="${#fields.hasErrors('discountValue')}" th:errors="*{discountValue}"></div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group" id="maxDiscountAmountGroup">
                            <label>Mức giảm tối đa (VNĐ)</label>
                            <input type="text" id="maxDiscountAmount" placeholder="VD: 100,000">
                            <input type="hidden" th:field="*{maxDiscountAmount}" id="maxDiscountAmountHidden">
                            <small style="color: #6b7280; font-size: 12px;">Chỉ cho giảm theo % (không bắt buộc)</small>
                        </div>
                        <div class="form-group">
                            <label>Giá trị đơn hàng tối thiểu (VNĐ)</label>
                            <input type="text" id="minOrderValue" placeholder="VD: 500,000">
                            <input type="hidden" th:field="*{minOrderValue}" id="minOrderValueHidden">
                            <small style="color: #6b7280; font-size: 12px;">Đơn hàng tối thiểu để áp dụng (không bắt buộc)</small>
                        </div>
                    </div>

                    <!-- Phạm vi áp dụng section -->
                    <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid #e5e7eb;">
                        <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: #1f2937;">Phạm vi áp dụng</h4>
                        
                        <div class="form-group full-width">
                            <label class="required">Loại áp dụng</label>
                            <select id="targetTypeSelect" th:field="*{targetType}" 
                                    required onchange="toggleTargetSelection(true)">
                                <option value="">-- Chọn phạm vi --</option>
                                <option value="ALL">Tất cả sản phẩm</option>
                                <option value="PRODUCT">Sản phẩm cụ thể</option>
                                <option value="CATEGORY">Theo danh mục</option>
                            </select>
                            <small style="color: #6b7280; font-size: 12px;">Chọn phạm vi sản phẩm được áp dụng giảm giá</small>
                        </div>
                        
                        <div id="productSelection" class="form-group full-width" style="display: none;">
                            <label class="required">Chọn sản phẩm</label>
                            <select name="shoeIds" multiple size="8" style="height: auto;">
                                <option th:each="shoe : ${allShoes}" 
                                        th:value="${shoe.shoeId}" 
                                        th:text="${shoe.name}"
                                        th:selected="${selectedShoeIds != null && #lists.contains(selectedShoeIds, shoe.shoeId)}">
                                </option>
                            </select>
                            <small style="color: #6b7280; font-size: 12px;">Giữ Ctrl (Windows) hoặc Cmd (Mac) để chọn nhiều sản phẩm</small>
                        </div>
                        
                        <div id="categorySelection" class="form-group full-width" style="display: none;">
                            <label class="required">Chọn danh mục</label>
                            <select name="categoryIds" multiple size="5" style="height: auto;">
                                <option th:each="cat : ${allCategories}" 
                                        th:value="${cat.categoryId}" 
                                    th:text="${cat.name}"
                                        th:selected="${selectedCategoryIds != null && #lists.contains(selectedCategoryIds, cat.categoryId)}">
                                </option>
                            </select>
                            <small style="color: #6b7280; font-size: 12px;">Giữ Ctrl (Windows) hoặc Cmd (Mac) để chọn nhiều danh mục</small>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary" style="padding: 12px 28px; border-radius: 10px;">
                            Lưu chiến dịch
                        </button>
                        <a th:href="@{/admin/promotions/campaigns}" class="btn btn-secondary" style="padding: 12px 28px; border-radius: 10px;">
                            Hủy bỏ
                        </a>
                    </div>
                </form>
            </div>
        </main>
    </div>
</div>
<script>
    document.addEventListener('click', function (e) {
        if (!e.target.matches('.menu-toggle')) return;
        const sidebar = document.querySelector('.sidebar');
        if (sidebar) sidebar.classList.toggle('collapsed');
    });
    
    // Format số theo chuẩn Việt Nam (dấu chấm phân cách hàng nghìn)
    function formatNumber(num) {
        if (!num) return '';
        return Number(num).toLocaleString('vi-VN');
    }
    
    function parseNumber(str) {
        if (!str) return '';
        // Bỏ tất cả ký tự không phải số
        return str.toString().replace(/[^\d]/g, '');
    }
    
    // Format currency inputs - focus bỏ format, blur format lại
    function setupCurrencyInput(displayId, hiddenId) {
        const displayInput = document.getElementById(displayId);
        const hiddenInput = document.getElementById(hiddenId);
        
        if (!displayInput || !hiddenInput) return;
        
        // Khi focus: bỏ format, hiển thị số thuần
        displayInput.addEventListener('focus', function(e) {
            const value = parseNumber(e.target.value);
            if (value) {
                e.target.value = value;
            }
        });
        
        // Khi blur: format với toLocaleString('vi-VN')
        displayInput.addEventListener('blur', function(e) {
            let value = parseNumber(e.target.value);
            if (value) {
                e.target.value = formatNumber(value);
                hiddenInput.value = value;
            } else {
                e.target.value = '';
                hiddenInput.value = '';
            }
        });
        
        // Chỉ cho nhập số
        displayInput.addEventListener('keypress', function(e) {
            if (!/[0-9]/.test(e.key)) {
                e.preventDefault();
            }
        });
    }
    
    // Toggle maxDiscountAmount field visibility based on discountType
    function toggleMaxDiscountField() {
        const discountType = document.getElementById('discountTypeSelect').value;
        const maxDiscountGroup = document.getElementById('maxDiscountAmountGroup');
        
        if (discountType === 'PERCENT') {
            // Giảm % → hiện field giảm tối đa
            maxDiscountGroup.style.display = 'block';
        } else {
            // Giảm cố định → ẩn field giảm tối đa
            maxDiscountGroup.style.display = 'none';
            // Clear giá trị
            document.getElementById('maxDiscountAmount').value = '';
            document.getElementById('maxDiscountAmountHidden').value = '';
        }
    }
    
    // Update discount value based on type
    function updateDiscountValuePlaceholder() {
        const discountType = document.getElementById('discountTypeSelect').value;
        const discountValueInput = document.getElementById('discountValue');
        const hint = document.getElementById('discountValueHint');
        
        if (discountType === 'PERCENT') {
            discountValueInput.placeholder = 'VD: 10';
            hint.textContent = 'Nhập số phần trăm (VD: 10 cho 10%)';
        } else if (discountType === 'FIXED_AMOUNT') {
            discountValueInput.placeholder = 'VD: 100000';
            hint.textContent = 'Nhập số tiền VNĐ ';
        } else {
            discountValueInput.placeholder = 'VD: 10 hoặc 100000';
            hint.textContent = 'Nếu % thì nhập 10, nếu VNĐ thì nhập 100000';
        }
        
        // Toggle maxDiscount field
        toggleMaxDiscountField();
    }
    
    // Setup discount value input
    function setupDiscountValueInput() {
        const displayInput = document.getElementById('discountValue');
        const hiddenInput = document.getElementById('discountValueHidden');
        const typeSelect = document.getElementById('discountTypeSelect');
        
        if (!displayInput || !hiddenInput) return;
        
        // Khi focus: bỏ format
        displayInput.addEventListener('focus', function(e) {
            const value = parseNumber(e.target.value);
            if (value) {
                e.target.value = value;
            }
        });
        
        // Khi blur: format nếu là FIXED_AMOUNT
        displayInput.addEventListener('blur', function(e) {
            const discountType = typeSelect.value;
            let value = parseNumber(e.target.value);
            
            if (value) {
                if (discountType === 'FIXED_AMOUNT') {
                    e.target.value = formatNumber(value);
                } else {
                    e.target.value = value;
                }
                hiddenInput.value = value;
            } else {
                e.target.value = '';
                hiddenInput.value = '';
            }
        });
        
        // Chỉ cho nhập số
        displayInput.addEventListener('keypress', function(e) {
            if (!/[0-9]/.test(e.key)) {
                e.preventDefault();
            }
        });
    }
    
    // Loading indicator for form submission
    document.querySelector('form').addEventListener('submit', function(e) {
        // KHÔNG gọi toggleTargetSelection() ở đây vì nó sẽ clear selections
        // Chỉ cần hiển thị loading overlay
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            overlay.classList.add('show');
        }
    });
    
    // Toggle target selection based on targetType
    // isUserAction = true khi người dùng thay đổi select, false khi page load
    function toggleTargetSelection(isUserAction = false) {
        const targetType = document.getElementById('targetTypeSelect').value;
        const productSelection = document.getElementById('productSelection');
        const categorySelection = document.getElementById('categorySelection');
        
        productSelection.style.display = 'none';
        categorySelection.style.display = 'none';
        
        if (targetType === 'PRODUCT') {
            productSelection.style.display = 'block';
            productSelection.querySelector('select').required = true;
            categorySelection.querySelector('select').required = false;
            // Clear category selection khi người dùng chuyển sang PRODUCT
            if (isUserAction) {
                const catSelect = categorySelection.querySelector('select');
                if (catSelect) Array.from(catSelect.options).forEach(opt => opt.selected = false);
            }
        } else if (targetType === 'CATEGORY') {
            categorySelection.style.display = 'block';
            categorySelection.querySelector('select').required = true;
            productSelection.querySelector('select').required = false;
            // Clear product selection khi người dùng chuyển sang CATEGORY
            if (isUserAction) {
                const prodSelect = productSelection.querySelector('select');
                if (prodSelect) Array.from(prodSelect.options).forEach(opt => opt.selected = false);
            }
        } else {
            productSelection.querySelector('select').required = false;
            categorySelection.querySelector('select').required = false;
            // Khi chọn ALL: clear cả product lẫn category (chỉ khi người dùng chủ động thay đổi)
            if (isUserAction) {
                const prodSelect = productSelection.querySelector('select');
                const catSelect = categorySelection.querySelector('select');
                if (prodSelect) Array.from(prodSelect.options).forEach(opt => opt.selected = false);
                if (catSelect) Array.from(catSelect.options).forEach(opt => opt.selected = false);
            }
        }
    }
    
    // Initialize on page load
    window.addEventListener('DOMContentLoaded', function() {
        toggleTargetSelection(false); // false = page load, không clear selections
        updateDiscountValuePlaceholder();
        
        // Setup currency formatting
        setupCurrencyInput('maxDiscountAmount', 'maxDiscountAmountHidden');
        setupCurrencyInput('minOrderValue', 'minOrderValueHidden');
        setupDiscountValueInput();
        
        // Load existing values from hidden inputs
        const discountValueHidden = document.getElementById('discountValueHidden');
        const discountValue = document.getElementById('discountValue');
        const discountType = document.getElementById('discountTypeSelect');
        
        if (discountValueHidden && discountValue && discountValueHidden.value) {
            const value = discountValueHidden.value;
            if (discountType.value === 'FIXED_AMOUNT') {
                discountValue.value = formatNumber(value);
            } else {
                discountValue.value = value;
            }
        }
        
        const maxDiscountHidden = document.getElementById('maxDiscountAmountHidden');
        const maxDiscount = document.getElementById('maxDiscountAmount');
        if (maxDiscountHidden && maxDiscount && maxDiscountHidden.value) {
            maxDiscount.value = formatNumber(maxDiscountHidden.value);
        }
        
        const minOrderHidden = document.getElementById('minOrderValueHidden');
        const minOrder = document.getElementById('minOrderValue');
        if (minOrderHidden && minOrder && minOrderHidden.value) {
            minOrder.value = formatNumber(minOrderHidden.value);
        }
        
        // Toggle target selection và maxDiscount field khi page load (cho trường hợp edit)
        toggleTargetSelection(false); // false = page load, không clear selections
        toggleMaxDiscountField();
    });
</script>
</body>
</html>
