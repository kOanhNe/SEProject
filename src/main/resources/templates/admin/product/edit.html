<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Ch·ªânh s·ª≠a s·∫£n ph·∫©m - Admin</title>
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <link rel="stylesheet" th:href="@{/css/common.css}">
    <style>
        .form-container {
            background: white;
            border-radius: 14px;
            padding: 32px;
            box-shadow: 0 8px 18px rgba(0,0,0,0.05);
            max-width: 900px;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 16px;
        }
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        .error-message {
            color: var(--danger);
            font-size: 13px;
            margin-top: 4px;
        }
        .image-list, .variant-list {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            margin-top: 8px;
        }
        .image-item, .variant-item {
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 10px;
            background: #f9fafb;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        .image-item input[type="text"], .variant-item input, .variant-item select {
            flex: 1;
        }
        .btn-remove {
            background: var(--danger);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
        }
        .btn-add {
            background: var(--success);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 8px;
        }
        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
        }
        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        label.required::after {
            content: " *";
            color: var(--danger);
        }
        .info-badge {
            display: inline-block;
            padding: 4px 10px;
            background: #e3f2fd;
            border-radius: 4px;
            font-size: 13px;
            margin-left: 10px;
        }
        .upload-controls {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .upload-status {
            font-size: 12px;
            color: #555;
            min-width: 110px;
        }
    </style>
</head>
<body>

<div class="admin-layout">

    <aside class="sidebar">
        <div th:replace="~{admin/sidebar :: sidebar}"></div>
    </aside>

    <div class="main">

        <header class="topbar">
            <div class="topbar-inner">
                <div class="topbar-left">
                    <button class="menu-toggle" aria-label="Toggle menu">‚ò∞</button>
                    <h3>Ch·ªânh s·ª≠a s·∫£n ph·∫©m</h3>
                </div>
                <div class="topbar-right">
                    <div class="user">Admin</div>
                </div>
            </div>
        </header>

        <main class="page-content">

            <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

            <div class="form-container">
                <form th:action="@{/admin/products/{id}/edit(id=${shoes != null ? shoes.shoeId : 0})}" method="post">

                    <h2 style="margin-top: 0;">
                        Th√¥ng tin c∆° b·∫£n
                        <span class="info-badge">ID: <span th:text="${shoes.shoeId}">1</span></span>
                    </h2>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="name" class="required">T√™n s·∫£n ph·∫©m</label>
                            <input type="text" id="name" name="name" th:value="${shoes.name}" required>
                        </div>

                        <div class="form-group">
                            <label for="brand" class="required">Th∆∞∆°ng hi·ªáu</label>
                            <input type="text" id="brand" name="brand" th:value="${shoes.brand}" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="type" class="required">Lo·∫°i gi√†y</label>
                            <select id="type" name="type" required>
                                <option value="">-- Ch·ªçn lo·∫°i --</option>
                                <option th:each="t : ${shoesTypes}" 
                                        th:value="${t}" 
                                        th:text="${t}"
                                        th:selected="${t == shoes.type}">FOR_MALE</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="categoryId" class="required">Danh m·ª•c</label>
                            <select id="categoryId" name="categoryId" required>
                                <option value="">-- Ch·ªçn danh m·ª•c --</option>
                                <option th:each="cat : ${categories}" 
                                        th:value="${cat.categoryId}" 
                                        th:text="${cat.name}"
                                        th:selected="${cat.categoryId == shoes.categoryId}">Gi√†y th·ªÉ thao</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="basePrice" class="required">Gi√° (VNƒê)</label>
                            <input type="number" id="basePrice" name="basePrice" th:value="${shoes.basePrice}" min="0" required>
                        </div>

                        <div class="form-group">
                            <label for="collection">B·ªô s∆∞u t·∫≠p</label>
                            <input type="text" id="collection" name="collection" th:value="${shoes.collection}">
                        </div>
                    </div>

                    <div class="form-group full-width">
                        <label for="description">M√¥ t·∫£ s·∫£n ph·∫©m</label>
                        <textarea id="description" name="description" rows="4" th:text="${shoes.description}"></textarea>
                    </div>

                    <hr style="margin: 32px 0; border: none; height: 1px; background: var(--border);">

                    <h2>H√¨nh ·∫£nh s·∫£n ph·∫©m</h2>
                    <div id="imageList" class="image-list">
                        <!-- Existing images -->
                        <div th:each="img, iterStat : ${shoes.images}" class="image-item">
                            <input type="hidden" th:name="|images[${iterStat.index}].imageId|" th:value="${img.imageId}">
                            <input type="text" th:name="|images[${iterStat.index}].url|" th:value="${img.url}" placeholder="URL h√¨nh ·∫£nh" required>
                            <label style="display: flex; align-items: center; gap: 6px; white-space: nowrap;">
                                <input type="checkbox" th:name="|images[${iterStat.index}].isThumbnail|" value="true" th:checked="${img.thumbnail}">
                                ·∫¢nh ƒë·∫°i di·ªán
                            </label>
                            <div class="upload-controls">
                                <input type="file" accept="image/*" onchange="handleFileChosen(this)">
                                <button type="button" class="btn" onclick="uploadImage(this)">Upload</button>
                                <span class="upload-status"></span>
                            </div>
                            <button type="button" class="btn-remove" onclick="removeImage(this)">X√≥a</button>
                        </div>
                        <!-- If no images -->
                        <div th:if="${#lists.isEmpty(shoes.images)}" class="image-item">
                            <input type="text" name="images[0].url" placeholder="URL h√¨nh ·∫£nh" required>
                            <label style="display: flex; align-items: center; gap: 6px; white-space: nowrap;">
                                <input type="checkbox" name="images[0].isThumbnail" value="true">
                                ·∫¢nh ƒë·∫°i di·ªán
                            </label>
                            <div class="upload-controls">
                                <input type="file" accept="image/*" onchange="handleFileChosen(this)">
                                <button type="button" class="btn" onclick="uploadImage(this)">Upload</button>
                                <span class="upload-status"></span>
                            </div>
                            <button type="button" class="btn-remove" onclick="removeImage(this)">X√≥a</button>
                        </div>
                    </div>
                    <button type="button" class="btn-add" onclick="addImage()">‚ûï Th√™m h√¨nh ·∫£nh</button>

                    <hr style="margin: 32px 0; border: none; height: 1px; background: var(--border);">

                    <h2>Bi·∫øn th·ªÉ (M√†u - Size)</h2>
                    <div id="variantList" class="variant-list">
                        <!-- Existing variants -->
                        <div th:each="v, iterStat : ${shoes.variants}" class="variant-item">
                            <input type="hidden" th:name="|variants[${iterStat.index}].variantId|" th:value="${v.variantId}">
                            <select th:name="|variants[${iterStat.index}].color|" required>
                                <option value="">-- Ch·ªçn m√†u --</option>
                                <option th:if="${v.color != null}" th:value="${v.color}" th:text="${v.color}" selected>--Gi√° tr·ªã hi·ªán t·∫°i--</option>
                                <option value="BLACK" th:selected="${v.color == 'BLACK'}">ƒêen</option>
                                <option value="WHITE" th:selected="${v.color == 'WHITE'}">Tr·∫Øng</option>
                                <option value="BLUE" th:selected="${v.color == 'BLUE'}">Xanh d∆∞∆°ng</option>
                                <option value="RED" th:selected="${v.color == 'RED'}">ƒê·ªè</option>
                                <option value="GRAY" th:selected="${v.color == 'GRAY'}">X√°m</option>
                                <option value="BROWN" th:selected="${v.color == 'BROWN'}">N√¢u</option>
                                <option value="PINK" th:selected="${v.color == 'PINK'}">H·ªìng</option>
                            </select>
                            <select th:name="|variants[${iterStat.index}].size|" required>
                                <option value="">-- Ch·ªçn size --</option>
                                <option th:if="${v.size != null}" th:value="${v.size}" th:text="${#strings.replace(v.size,'SIZE_','')}" selected>--Hi·ªán t·∫°i--</option>
                                <option th:each="s : ${#numbers.sequence(35, 45)}" 
                                    th:value="${'SIZE_' + s}" 
                                    th:text="${s}"
                                    th:selected="${v.size == 'SIZE_' + s}"></option>
                            </select>
                            <button type="button" class="btn-remove" onclick="removeVariant(this)">X√≥a</button>
                        </div>
                        <!-- If no variants -->
                        <div th:if="${#lists.isEmpty(shoes.variants)}" class="variant-item">
                            <select name="variants[0].color" required>
                                <option value="">-- Ch·ªçn m√†u --</option>
                                <option value="BLACK">ƒêen</option>
                                <option value="WHITE">Tr·∫Øng</option>
                                <option value="BLUE">Xanh d∆∞∆°ng</option>
                                <option value="RED">ƒê·ªè</option>
                                <option value="GRAY">X√°m</option>
                                <option value="BROWN">N√¢u</option>
                                <option value="PINK">H·ªìng</option>
                            </select>
                            <select name="variants[0].size" required>
                                <option value="">-- Ch·ªçn size --</option>
                                <option th:each="s : ${#numbers.sequence(35, 45)}" th:value="${'SIZE_' + s}" th:text="${s}"></option>
                            </select>
                            <button type="button" class="btn-remove" onclick="removeVariant(this)">X√≥a</button>
                        </div>
                    </div>
                    <button type="button" class="btn-add" onclick="addVariant()">‚ûï Th√™m bi·∫øn th·ªÉ</button>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">üíæ C·∫≠p nh·∫≠t s·∫£n ph·∫©m</button>
                        <a th:href="@{/admin/products}" class="btn btn-secondary">‚ùå H·ªßy</a>
                    </div>

                </form>
            </div>

        </main>

    </div>

</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    let imageIndex = /*[[${#lists.size(shoes.images)}]]*/ 0;
    let variantIndex = /*[[${#lists.size(shoes.variants)}]]*/ 0;
    /*]]>*/

    function addImage() {
        const list = document.getElementById('imageList');
        const div = document.createElement('div');
        div.className = 'image-item';
        div.innerHTML = `
            <input type="text" name="images[${imageIndex}].url" placeholder="URL h√¨nh ·∫£nh" required>
            <label style="display: flex; align-items: center; gap: 6px; white-space: nowrap;">
                <input type="checkbox" name="images[${imageIndex}].isThumbnail" value="true">
                ·∫¢nh ƒë·∫°i di·ªán
            </label>
            <div class="upload-controls">
                <input type="file" accept="image/*" onchange="handleFileChosen(this)">
                <button type="button" class="btn" onclick="uploadImage(this)">Upload</button>
                <span class="upload-status"></span>
            </div>
            <button type="button" class="btn-remove" onclick="removeImage(this)">X√≥a</button>
        `;
        list.appendChild(div);
        imageIndex++;
    }

    function removeImage(btn) {
        const list = document.getElementById('imageList');
        btn.parentElement.remove();
    }

    function addVariant() {
        const list = document.getElementById('variantList');
        const div = document.createElement('div');
        div.className = 'variant-item';
        div.innerHTML = `
            <select name="variants[${variantIndex}].color" required>
                <option value="">-- Ch·ªçn m√†u --</option>
                <option value="BLACK">ƒêen</option>
                <option value="WHITE">Tr·∫Øng</option>
                <option value="BLUE">Xanh d∆∞∆°ng</option>
                <option value="RED">ƒê·ªè</option>
                <option value="GRAY">X√°m</option>
                <option value="BROWN">N√¢u</option>
                <option value="PINK">H·ªìng</option>
            </select>
            <select name="variants[${variantIndex}].size" required>
                <option value="">-- Ch·ªçn size --</option>
                ${[35,36,37,38,39,40,41,42,43,44,45].map(s => `<option value="SIZE_${s}">${s}</option>`).join('')}
            </select>
            <button type="button" class="btn-remove" onclick="removeVariant(this)">X√≥a</button>
        `;
        list.appendChild(div);
        variantIndex++;
        reindexVariants();
    }

    function removeVariant(btn) {
        const list = document.getElementById('variantList');
        if (list.children.length > 1) {
            btn.parentElement.remove();
            reindexVariants();
        } else {
            alert('Ph·∫£i c√≥ √≠t nh·∫•t 1 bi·∫øn th·ªÉ');
        }
    }

    function reindexVariants() {
        const list = document.getElementById('variantList');
        Array.from(list.children).forEach((item, idx) => {
            const variantId = item.querySelector('input[type="hidden"][name*="variantId"]');
            if (variantId) {
                variantId.name = `variants[${idx}].variantId`;
            }
            const selects = item.querySelectorAll('select');
            selects.forEach(sel => {
                if (sel.name.includes('.color')) {
                    sel.name = `variants[${idx}].color`;
                } else if (sel.name.includes('.size')) {
                    sel.name = `variants[${idx}].size`;
                }
            });
        });
        variantIndex = list.children.length;
    }

    // Toggle sidebar
    document.addEventListener('click', function (e) {
        if (!e.target.matches('.menu-toggle')) return;
        const sidebar = document.querySelector('.sidebar');
        if (sidebar) {
            sidebar.classList.toggle('collapsed');
        }
    });

    function handleFileChosen(input) {
        const status = input.closest('.image-item').querySelector('.upload-status');
        if (status) status.textContent = input.files && input.files[0] ? input.files[0].name : '';
    }

    async function uploadImage(btn) {
        const container = btn.closest('.image-item');
        const fileInput = container.querySelector('input[type="file"]');
        const urlInput = container.querySelector('input[type="text"][name*="images"][name$=".url"]');
        const status = container.querySelector('.upload-status');

        if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
            alert('Vui l√≤ng ch·ªçn file ·∫£nh');
            return;
        }

        const file = fileInput.files[0];
        btn.disabled = true;
        if (status) status.textContent = 'ƒêang upload...';

        const formData = new FormData();
        formData.append('file', file);

        try {
            const resp = await fetch('/admin/uploads/images', {
                method: 'POST',
                body: formData
            });
            const data = await resp.json();
            if (!resp.ok) {
                throw new Error(data.error || 'Upload th·∫•t b·∫°i');
            }
            urlInput.value = data.url;
            if (status) status.textContent = 'ƒê√£ nh·∫≠n URL';
        } catch (err) {
            alert(err.message);
            if (status) status.textContent = 'L·ªói upload';
        } finally {
            btn.disabled = false;
        }
    }

    // Tr∆∞·ªõc khi submit: b·ªè c√°c item ·∫£nh kh√¥ng c√≥ URL, ƒë·∫£m b·∫£o c√≤n √≠t nh·∫•t 1
    document.querySelector('form').addEventListener('submit', function (e) {
        const list = document.getElementById('imageList');
        const items = Array.from(list.querySelectorAll('.image-item'));
        items.forEach(item => {
            const urlInput = item.querySelector('input[type="text"][name*="images"][name$=".url"]');
            if (!urlInput || !urlInput.value.trim()) {
                item.remove();
            }
        });
        const remaining = list.querySelectorAll('.image-item');
        if (remaining.length === 0) {
            e.preventDefault();
            alert('Vui l√≤ng upload √≠t nh·∫•t 1 h√¨nh ·∫£nh h·ª£p l·ªá');
        }
    });
</script>

</body>
</html>
